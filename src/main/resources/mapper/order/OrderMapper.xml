<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bonestew.popmate.order.persistence.OrderDao">

  <resultMap id="popupStoreMap" type="PopupStore">
    <result column="popup_store_id" property="popupStoreId"/>
  </resultMap>

  <resultMap id="popupStoreItemMap" type="PopupStoreItem">
    <result column="popup_store_item_id" property="popupStoreItemId"/>
    <result column="name" property="name"/>
    <result column="img_url" property="imgUrl"/>
    <result column="amount" property="amount"/>
    <result column="stock" property="stock"/>
    <result column="order_limit" property="orderLimit"/>
    <result column="created_at" property="createdAt"/>
    <collection column="popup_store_id" property="popupStore" resultMap="popupStoreMap"/>
  </resultMap>


  <select id="getItems" parameterType="long" resultMap="popupStoreItemMap">
    SELECT *
    FROM TB_POPUP_STORE_ITEM
    WHERE popup_store_id = #{popupStoreId}
  </select>

  <select id="selectSequence" resultType="long">
    SELECT tb_order_seq.NEXTVAL as orderId FROM DUAL
  </select>

  <insert id="insertOrderTable" parameterType="java.util.Map">
    INSERT INTO tb_order (order_id, user_id, popup_store_id, amount)
    VALUES (#{orderId}, #{userId}, #{storeId}, #{totalAmount})
  </insert>

  <select id="findStock" parameterType="java.util.Map" resultType="int">
    SELECT stock
    FROM TB_POPUP_STORE_ITEM
    WHERE popup_store_id = #{storeId} and popup_store_item_id = #{itemId}
  </select>

  <insert id="insertOrderItemTable" parameterType="java.util.Map">
    INSERT INTO tb_order_item (order_id, popup_store_item_id, total_amount, total_quantity)
    VALUES (#{orderId}, #{itemId}, #{totalItemAmount}, #{totalQuantity})
  </insert>

  <update id="updateStoreItemTable" parameterType="java.util.Map">
    UPDATE tb_popup_store_item
    SET stock = #{updateStock}
    WHERE popup_store_item_id = #{itemId} and popup_store_id = #{storeId}
  </update>


  <!--
  <insert id="insertOrderTable" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="orderId">
    <selectKey keyProperty="orderId" resultType="long" order="BEFORE">
      SELECT tb_order_seq.NEXTVAL as orderId FROM DUAL
    </selectKey>
    INSERT INTO tb_order (user_id, popup_store_id, amount)
    VALUES (#{userId}, #{storeId}, #{totalAmount})
  </insert>
  -->
</mapper>
